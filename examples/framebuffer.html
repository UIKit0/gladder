<!DOCTYPE html>
<html>
  <head>
    <title>Gladder : Framebuffer example</title>
    <script src="../src/gl-matrix.js"></script>
    <script src="../src/webgl-debug.js"></script>
    <script src="../src/gladder.js"></script>
  </head>
  <body>
    <h1>Gladder : Framebuffer example</h1>
    <p>This shows how to use framebuffers for post-processing effects, such as a Gaussian blur.</p>

    <canvas id="canvas" width="640" height="640"></canvas>

    <script id="triangle-vertex-shader" type="x-shader/x-vertex">
      uniform mat4 transform;
      attribute vec2 position;
      varying vec4 color;
      varying vec2 pos;
      void main() {
        gl_Position = transform * vec4(position, 0.0, 1.0);
        pos = position;
      }
    </script>

    <script id="triangle-fragment-shader" type="x-shader/x-fragment">
      precision mediump float;
      varying vec2 pos;
      void main() {
        float brightness = step(0.0, sin(12.0 * (atan(pos.y, pos.x) + 3.0 * length(pos))));
        gl_FragColor.rgb = vec3(1.0, 1.0, 1.0) * brightness;
        gl_FragColor.a = 1.0;
      }
    </script>

    <script id="blur-vertex-shader" type="x-shader/x-vertex">
      attribute vec2 position;
      varying vec2 texCoord;
      void main() {
        gl_Position = vec4(2.0 * position - 1.0, 0.0, 1.0);
        texCoord = position;
      }
    </script>

    <script id="blur-fragment-shader" type="x-shader/x-fragment">
      precision mediump float;
      varying vec2 texCoord;
      uniform vec2 offset;
      uniform sampler2D sampler;
      void main() {
        gl_FragColor =
          texture2D(sampler, texCoord - 4.0 * offset) * 0.05 +
          texture2D(sampler, texCoord - 3.0 * offset) * 0.09 +
          texture2D(sampler, texCoord - 2.0 * offset) * 0.12 +
          texture2D(sampler, texCoord -       offset) * 0.15 +
          texture2D(sampler, texCoord               ) * 0.16 +
          texture2D(sampler, texCoord -       offset) * 0.15 +
          texture2D(sampler, texCoord - 2.0 * offset) * 0.12 +
          texture2D(sampler, texCoord - 3.0 * offset) * 0.09 +
          texture2D(sampler, texCoord - 4.0 * offset) * 0.05;
      }
    </script>

    <script>
      var gla = new Gladder({
        canvas: "canvas",
        debug: true,
        errorCallback: function(err) { console.error(err); },
      });

      gla.clear({ color: [0, 0, 0] });

      var triangleProgram = new gla.Program({
        vertexShader: "triangle-vertex-shader",
        fragmentShader: "triangle-fragment-shader",
        uniforms: { transform: "mat4" },
        attributes: { position: "vec2" },
      });

      var triangleBuffer = new gla.Buffer({
        data: [ 0,3, -1.5*Math.sqrt(3),-1.5, 1.5*Math.sqrt(3),-1.5 ],
        componentsPerItem: 2,
      });

      var transform = mat4.create();

      var framebuffer1 = new gla.Framebuffer({
        colorBuffer: gla.CREATE_TEXTURE_2D,
      });
      framebuffer1.checkComplete();
      var framebuffer2 = new gla.Framebuffer({
        colorBuffer: gla.CREATE_TEXTURE_2D,
      });
      framebuffer2.checkComplete();

      var blurProgram = new gla.Program({
        vertexShader: "blur-vertex-shader",
        fragmentShader: "blur-fragment-shader",
        uniforms: { sampler: "sampler2D", offset: "vec2" },
        attributes: { position: "vec2" },
      });

      var unitQuadBuffer = new gla.Buffer({
        data: [ 0,0, 1,0, 1,1, 0,1 ],
        componentsPerItem: 2,
      });

      var angle = 0;
      gla.mainLoop(function(delta) {
        angle += 0.00002 * delta;
        mat4.identity(transform);
        mat4.rotate(transform, angle, [0, 0, 1]);

        // Render the triangle to the first framebuffer
        framebuffer1.withBound(function() {
          gla.clear({ color: [1, 1, 1] });

          gla.draw({
            program: triangleProgram,
            uniforms: { transform: transform },
            attributes: { position: triangleBuffer },
            count: triangleBuffer.numItems,
          });
        });

        // Render the scene to the second framebuffer, vertically blurred
        framebuffer2.withBound(function() {
          framebuffer1.colorBuffer.withBound(0, function() {
            gla.draw({
              program: blurProgram,
              uniforms: { sampler: 0, offset: [0, 1 / gla.canvas.height] },
              attributes: { position: unitQuadBuffer },
              count: unitQuadBuffer.numItems,
              mode: gla.DrawMode.TRIANGLE_FAN,
            });
          });
        });

        // Render the vertically blurred framebuffer to the screen, horizontally blurred
        // TODO auto-bind textures
        framebuffer2.colorBuffer.withBound(0, function() {
          gla.draw({
            program: blurProgram,
            uniforms: { sampler: 0, offset: [1 / gla.canvas.width, 0] },
            attributes: { position: unitQuadBuffer },
            count: unitQuadBuffer.numItems,
            mode: gla.DrawMode.TRIANGLE_FAN,
          });
        });
      });
    </script>
  </body>
</html>
